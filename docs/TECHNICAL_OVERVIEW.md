# 🔧 Техническое описание проекта

## 📋 Общая информация

**Название**: YM Image Processor (K+ Content Service)  
**Версия**: 2.0  
**Дата последнего обновления**: 8 января 2025  
**Тип**: Веб-сервис для обработки изображений товаров  

## 🎯 Назначение

Автоматизированная система обработки изображений товаров для Яндекс Маркета с использованием AI технологий:
- Удаление фона с помощью FLUX Kontext LoRA 
- GPT-4 анализ товаров
- Умное позиционирование
- Пакетная обработка

## 🏗️ Архитектура системы

### Основные компоненты

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend UI   │───▶│  Flask Backend  │───▶│   AI Services   │
│                 │    │                 │    │                 │
│ • Web Interface │    │ • API Routes    │    │ • FLUX Kontext  │
│ • File Upload   │    │ • Batch Proc.   │    │ • GPT-4 Vision  │
│ • Progress      │    │ • Database      │    │ • BiRefNet      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Архитектурные слои

1. **Presentation Layer** (Веб-интерфейс)
   - HTML/CSS/JavaScript фронтенд
   - Загрузка файлов, отображение прогресса
   - Интерактивное управление обработкой

2. **Application Layer** (Backend логика)
   - Flask веб-сервер
   - API endpoints для обработки
   - Управление сессиями и прогрессом

3. **Business Logic Layer** (Процессоры)
   - BatchProcessor - пакетная обработка
   - GPTProductAnalyzer - анализ товаров
   - SmartPositioning - позиционирование

4. **Integration Layer** (Внешние API)
   - fal.ai для FLUX Kontext и BiRefNet
   - OpenAI для GPT-4 анализа
   - Собственные LoRA модели

5. **Data Layer** (Хранение)
   - SQLite база данных (история)
   - Файловая система (изображения)
   - Временные файлы обработки

## 📁 Структура проекта

```
K+ content service/
├── 📱 Основные приложения
│   ├── app_batch.py           # Главное приложение с полным функционалом
│   └── app_api.py             # Упрощенное API приложение
│
├── 🧠 Бизнес-логика (src/)
│   ├── processors/
│   │   ├── batch_processor.py  # Пакетная обработка
│   │   ├── gpt_analyzer.py     # GPT-4 анализ
│   │   ├── smart_positioning.py # Умное позиционирование
│   │   └── background.py       # Удаление фона (legacy)
│   └── utils/
│       ├── image_helpers.py    # Утилиты для изображений
│       └── monitoring.py       # Мониторинг системы
│
├── 🧪 Тестирование
│   ├── tests/                  # Unit тесты
│   └── test_processor.py       # Основные тесты
│
├── 📚 Документация
│   ├── docs/
│   │   ├── TECHNICAL_OVERVIEW.md  # Этот файл
│   │   ├── API_DOCUMENTATION.md   # API документация
│   │   ├── DEPLOYMENT_GUIDE.md    # Руководство по развертыванию
│   │   └── progress/               # История изменений
│   └── CHANGELOG.md               # Лог изменений
│
├── ⚙️ Конфигурация
│   ├── config/
│   │   ├── nginx.conf             # Nginx конфигурация
│   │   ├── docker-compose.yml     # Docker Compose
│   │   └── pytest.ini             # Настройки тестов
│   ├── Dockerfile                 # Docker образ
│   └── requirements.txt           # Python зависимости
│
├── 🔧 Скрипты
│   ├── scripts/
│   │   ├── check_database.py      # Проверка БД
│   │   └── webhook_server.py      # Webhook сервер
│   └── auto_deploy.sh             # Автоматическое развертывание
│
├── 📦 Архив
│   └── archive/                   # Устаревшие файлы
│
└── 💾 Данные
    ├── database/                  # SQLite база
    ├── processed/                 # Обработанные файлы
    └── flagged/                   # Помеченные файлы
```

## 🔄 Рабочий процесс

### 1. Загрузка изображения
- Пользователь загружает изображение через веб-интерфейс
- Валидация формата и размера
- Сохранение во временную директорию

### 2. GPT-4 Анализ
- Анализ изображения через OpenAI Vision API
- Определение категории товара
- Генерация оптимизированного промпта

### 3. Удаление фона
- **LoRA V1**: Базовая модель (30 шагов, guidance 2.5)
- **LoRA V2**: Улучшенная модель (50 шагов, guidance 3.5)
- **Fallback**: BiRefNet при сбоях LoRA

### 4. Пост-обработка
- Умное позиционирование (опционально)
- Добавление теней
- Оптимизация качества

### 5. Сохранение результата
- Сохранение в базу данных
- Архивирование файлов
- Генерация отчета

## 🛠️ Технологический стек

### Backend
- **Python 3.9+** - Основной язык
- **Flask** - Веб-фреймворк
- **SQLite** - База данных
- **Pillow** - Обработка изображений
- **OpenCV** - Компьютерное зрение

### AI/ML сервисы
- **OpenAI GPT-4 Vision** - Анализ товаров
- **fal.ai FLUX Kontext** - Удаление фона с LoRA
- **BiRefNet** - Fallback удаление фона
- **Собственные LoRA модели** - Специализированные модели

### DevOps
- **Docker** - Контейнеризация
- **nginx** - Веб-сервер
- **GitHub Actions** - CI/CD
- **SSH/expect** - Автоматизация развертывания

### Frontend
- **HTML5/CSS3** - Базовая разметка
- **JavaScript** - Интерактивность
- **Bootstrap** - UI компоненты
- **AJAX** - Асинхронные запросы

## 🔧 Ключевые возможности

### ✅ Реализовано
- 🖼️ **Пакетная обработка изображений**
- 🧠 **GPT-4 анализ товаров**
- 🎨 **Удаление фона с LoRA V1/V2**
- 📊 **Отслеживание прогресса в реальном времени**
- 💾 **История обработки**
- 🐳 **Docker развертывание**
- 🤖 **Автоматическое развертывание**

### 🔄 В разработке
- 📐 **Улучшенное позиционирование**
- 🎭 **Генерация теней**
- 📈 **Аналитика и метрики**
- 🔧 **API v2 с аутентификацией**

## 📊 Производительность

### Время обработки (среднее)
- **GPT-4 анализ**: 2-5 секунд
- **LoRA V1 (30 шагов)**: 15-25 секунд  
- **LoRA V2 (50 шагов)**: 25-40 секунд
- **BiRefNet fallback**: 5-10 секунд
- **Полный цикл**: 30-60 секунд

### Ресурсы
- **RAM**: 2-4 GB (в зависимости от размера изображения)
- **CPU**: Умеренное использование
- **Сеть**: Активное использование (API вызовы)
- **Диск**: 100-500 MB на изображение (временно)

## 🔐 Безопасность

### Аутентификация
- API ключи для внешних сервисов
- Переменные окружения для конфиденциальных данных
- Валидация входных данных

### Ограничения
- Максимальный размер файла: 10 MB
- Поддерживаемые форматы: PNG, JPEG, WEBP
- Rate limiting для API вызовов

## 🚀 Развертывание

### Production среда
- **Сервер**: Ubuntu 24.04 LTS
- **IP**: 103.136.69.249:8080
- **Контейнер**: Docker с auto-restart
- **Мониторинг**: Docker logs

### Переменные окружения
```bash
FAL_KEY=<fal.ai_api_key>              # Официальный ключ
FAL_API_KEY=<fal.ai_api_key>          # Резервный ключ  
OPENAI_API_KEY=<openai_api_key>       # OpenAI GPT-4
LORA_PATH=<url_to_lora_model>         # Путь к LoRA модели
PORT=8080                             # Порт сервиса
```

## 📈 Метрики и мониторинг

### Логи
- Подробное логирование всех этапов
- Эмодзи-индикаторы статуса
- Отладочная информация для API вызовов

### База данных
- История всех обработок
- Временные метки
- Статус выполнения
- Ошибки и их описания

---

**Документ обновлен**: 8 января 2025  
**Версия документации**: 1.0  
**Автор**: AI Assistant (Claude)